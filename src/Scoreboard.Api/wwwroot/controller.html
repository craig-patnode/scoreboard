<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Scoreboard Control</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; }
		body { font-family: 'Arial', sans-serif; background: #1a1a1a; padding: 8px; color: #fff; }

		.login-screen {
			max-width: 380px; margin: 80px auto; background: #2a2a2a;
			border-radius: 10px; padding: 30px;
			box-shadow: 0 4px 20px rgba(0,0,0,0.5); text-align: center;
		}
		.login-screen h2 { color: #4CAF50; margin-bottom: 20px; font-size: 18px; letter-spacing: 2px; text-transform: uppercase; }
		.login-screen input {
			width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #555;
			background: #333; color: #fff; border-radius: 4px; font-size: 14px;
		}
		.login-screen button {
			width: 100%; padding: 10px; font-size: 14px; cursor: pointer; border-radius: 4px;
			border: none; background: #4CAF50; color: white; font-weight: bold; margin-top: 5px;
		}
		.login-error { color: #f44336; font-size: 12px; margin-top: 8px; }

		.container {
			max-width: 435px; margin: 0 auto; background: #2a2a2a;
			border-radius: 8px; padding: 10px;
			box-shadow: 0 4px 20px rgba(0,0,0,0.5); display: none;
		}
		h1 { text-align: center; font-size: 14px; margin-bottom: 6px; color: #4CAF50; text-transform: uppercase; letter-spacing: 2px; }

		.user-bar {
			display: flex; justify-content: space-between; align-items: center;
			margin-bottom: 4px; font-size: 9px; color: #888;
		}
		.user-bar .logout { cursor: pointer; color: #f44336; text-decoration: underline; }

		#connectionStatus {
			text-align: center; font-size: 9px; margin-bottom: 6px; padding: 2px; border-radius: 3px; background: #333;
		}

		.game-setup {
			background: #1a1a1a; padding: 8px; border-radius: 6px; margin-bottom: 8px;
			border: 1px solid #444; text-align: center; display: none;
		}
		.game-setup h3 { color: #4CAF50; font-size: 11px; margin-bottom: 6px; }
		.game-setup input {
			width: 80%; padding: 5px; margin-bottom: 5px; border: 1px solid #555;
			background: #333; color: #fff; border-radius: 4px; font-size: 11px; text-align: center;
		}
		.game-setup button { margin-top: 4px; }

		.scoreboard-wrapper {
			width: 100%; margin-bottom: 4px;
		}
		.scoreboard {
			display: grid; grid-template-columns: 1fr auto 1fr; gap: 6px;
			background: #1a1a1a; padding: 8px; border-radius: 6px; border: 2px solid #444; width: 100%;
		}
		.team { text-align: center; }
		.team-label { font-size: 8px; color: #888; margin-bottom: 2px; text-transform: uppercase; }
		.team-name-input {
			width: 100%; padding: 3px; font-size: 10px; border: 1px solid #555;
			background: #333; color: #fff; border-radius: 4px; margin-bottom: 3px;
			text-align: center; font-weight: bold;
		}
		.score-display {
			font-size: 18px; font-weight: bold; color: #ffffff; text-align: center;
			margin: 4px 0; font-family: 'Impact', sans-serif;
		}
		.score-controls { display: flex; justify-content: center; gap: 3px; margin-top: 3px; }

		.timer-section {
			background: #111; border: 1px solid #444; border-radius: 6px;
			display: flex; flex-direction: column; align-items: center; justify-content: center;
			border-left: 2px solid #444; border-right: 2px solid #444; padding: 4px;
		}
		.timer-display { font-size: 28px; font-weight: bold; color: #4CAF50; font-family: 'Courier New', monospace; margin-bottom: 2px; }
		.timer-controls { display: flex; gap: 3px; margin-bottom: 3px; }
		.timer-mode { font-size: 8px; color: #888; margin-top: 2px; padding: 2px; }

		.control-row { display: flex; align-items: center; gap: 3px; margin-bottom: 3px; justify-content: center; }

		button {
			padding: 4px 8px; font-size: 9px; cursor: pointer; border-radius: 3px;
			border: none; background: #4CAF50; color: white; font-weight: bold; transition: all 0.2s;
		}
		button:hover { opacity: 0.8; transform: translateY(-1px); }
		button:active { transform: translateY(0); }
		.btn-sm { padding: 2px 5px; font-size: 8px; }
		.btn-primary { background: #2196F3; }
		.btn-success { background: #4CAF50; }
		.btn-danger { background: #f44336; }
		.btn-warning { background: #ff9800; }
		.btn-secondary { background: #666; }
		.btn-light-warning { background: #FFB74D; }
		.btn-light-danger { background: #E57373; }

		input.mini { width: 28px; padding: 2px; font-size: 9px; text-align: center; border: 1px solid #555; background: #333; color: #fff; border-radius: 3px; }

		.panel-title { font-size: 9px; color: #4CAF50; margin-bottom: 4px; text-transform: uppercase; font-weight: bold; border-bottom: 1px solid #333; }

		.period-badge {
			display: inline-block; padding: 2px 6px; border-radius: 10px; font-size: 9px;
			font-weight: bold; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 3px;
		}
		.period-1h { background: #2196F3; color: #fff; }
		.period-2h { background: #4CAF50; color: #fff; }
		.period-ot1 { background: #ff9800; color: #fff; }
		.period-ot2 { background: #f44336; color: #fff; }
		.period-pen { background: #9C27B0; color: #fff; }

		.period-buttons { display: flex; gap: 2px; flex-wrap: wrap; justify-content: center; margin-top: 3px; }
		.period-buttons button { padding: 2px 5px; font-size: 8px; }
		.period-buttons button.active { box-shadow: 0 0 0 2px #FFD700; }

		.half-settings { display: flex; gap: 6px; justify-content: center; align-items: center; margin-bottom: 3px; }
		.half-settings label { font-size: 8px; color: #888; text-transform: uppercase; }
		.half-settings input { width: 32px; padding: 2px; font-size: 9px; text-align: center; border: 1px solid #555; background: #333; color: #fff; border-radius: 3px; }

		/* Toast */
		.toast {
			position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
			background: #f44336; color: #fff; padding: 6px 14px; border-radius: 5px;
			font-size: 11px; font-weight: bold; z-index: 9999;
			box-shadow: 0 4px 15px rgba(0,0,0,0.5);
			animation: toastIn 0.3s ease-out, toastOut 0.3s ease-in 2.7s forwards;
			display: none;
		}
		.toast.warning { background: #ff9800; }
		.toast.show { display: block; }
		@keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(-20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
		@keyframes toastOut { to { opacity: 0; transform: translateX(-50%) translateY(-20px); } }

		/* Loading indicators */
		@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
		.btn-spinner {
			display: inline-block; width: 14px; height: 14px;
			border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: #fff;
			border-radius: 50%; animation: spin 0.6s linear infinite;
			vertical-align: middle; margin-right: 6px;
		}
		button:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }
		.loading-overlay {
			position: fixed; top: 0; left: 0; width: 100%; height: 100%;
			background: #1a1a1a; display: flex; flex-direction: column;
			align-items: center; justify-content: center; z-index: 1000;
		}
		.loading-overlay .overlay-spinner {
			width: 40px; height: 40px; border: 3px solid #333;
			border-top-color: #4CAF50; border-radius: 50%;
			animation: spin 0.8s linear infinite; margin-bottom: 12px;
		}
		.loading-overlay .overlay-text {
			font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 2px;
		}
		@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
		.status-connecting { color: #ff9800; animation: pulse 1.5s ease-in-out infinite; }

		/* ===== Penalty Section ‚Äî ALWAYS VISIBLE standalone section ===== */
		.penalty-section {
			background: #1a1a1a; padding: 6px; border-radius: 6px; margin-top: 4px;
			border: 2px solid #9C27B0;
		}
		.penalty-section .panel-title { color: #9C27B0; }
		.penalty-grid {
			display: grid; grid-template-columns: 1fr auto 1fr; gap: 6px; align-items: start;
		}
		.penalty-team { text-align: center; }
		.penalty-team-name { font-size: 9px; font-weight: bold; color: #fff; margin-bottom: 3px; }
		.penalty-kicks { display: flex; gap: 3px; justify-content: center; margin-bottom: 4px; flex-wrap: wrap; }
		.kick-dot {
			width: 18px; height: 18px; border-radius: 50%; border: 2px solid #555;
			display: flex; align-items: center; justify-content: center;
			font-size: 8px; font-weight: bold; color: #fff;
		}
		.kick-goal { background: #4CAF50; border-color: #4CAF50; }
		.kick-miss { background: #f44336; border-color: #f44336; }
		.kick-pending { background: #333; border-color: #555; color: #555; }
		.penalty-score { font-size: 16px; font-weight: bold; color: #FFD700; font-family: 'Impact', sans-serif; }
		.penalty-score-sep { font-size: 16px; color: #888; }
		.penalty-controls { display: flex; gap: 2px; justify-content: center; }
		.penalty-winner {
			text-align: center; font-size: 10px; color: #FFD700; font-weight: bold;
			margin-top: 4px; display: none;
		}

		/* Appearance */
		.appearance-inline { margin-top: 4px; border-top: 1px solid #333; padding-top: 4px; }
		.appearance-row { display: flex; align-items: center; gap: 4px; margin-bottom: 3px; justify-content: center; }
		.appearance-row label { font-size: 8px; color: #888; text-transform: uppercase; min-width: 32px; text-align: right; }
		.color-picker { width: 24px; height: 18px; border: 1px solid #555; border-radius: 3px; cursor: pointer; padding: 0; background: none; }
		.logo-preview { width: 26px; height: 26px; border-radius: 3px; border: 1px solid #555; background: #333; object-fit: contain; }
		.logo-placeholder {
			width: 26px; height: 26px; border-radius: 3px; border: 1px dashed #555;
			background: #333; display: inline-flex; align-items: center; justify-content: center;
			font-size: 10px; color: #555;
		}
		.file-input-label { display: inline-block; padding: 1px 4px; font-size: 7px; background: #555; color: #fff; border-radius: 3px; cursor: pointer; }
		.file-input-label:hover { background: #666; }
		input[type="file"] { display: none; }

		.state-compact {
			background: #1a1a1a; padding: 5px; border-radius: 5px;
			font-size: 8px; line-height: 1.4; border: 1px solid #444; color: #aaa;
		}
		.state-compact strong { color: #4CAF50; }

		.obs-urls {
			background: #1a1a1a; padding: 5px; border-radius: 5px; margin-top: 4px;
			border: 1px solid #444; font-size: 8px;
		}
		.obs-urls .panel-title { margin-bottom: 3px; }
		.obs-url-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; gap: 3px; }
		.obs-url-row span { color: #aaa; white-space: nowrap; }
		.obs-url-row code { color: #4CAF50; font-size: 7px; word-break: break-all; flex: 1; }
		.copy-btn { padding: 2px 4px; font-size: 7px; background: #555; white-space: nowrap; }

		.theme-selector { display: flex; align-items: center; gap: 5px; margin-bottom: 4px; justify-content: center; }
		.theme-selector label { font-size: 8px; color: #888; text-transform: uppercase; }
		.theme-selector select { padding: 2px 5px; font-size: 9px; border: 1px solid #555; background: #333; color: #fff; border-radius: 3px; }

		.reset-row { text-align: center; margin-top: 3px; margin-bottom: 4px; }
	</style>
</head>
<body>
	<div class="toast" id="toast"></div>
	<div class="loading-overlay" id="loadingOverlay" style="display: none;">
		<div class="overlay-spinner"></div>
		<div class="overlay-text">Loading Game‚Ä¶</div>
	</div>

	<div class="login-screen" id="loginScreen">
		<h2>‚öΩ Scoreboard Login</h2>
		<input type="email" id="loginEmail" placeholder="Email Address" />
		<input type="password" id="loginPassword" placeholder="Password" />
		<button id="loginBtn" onclick="login()">Sign In</button>
		<div class="login-error" id="loginError"></div>
		<div style="margin-top: 15px; font-size: 11px; color: #666;">
			<a href="/signup.html" style="color: #4CAF50;">Create Account</a>
		</div>
	</div>

	<div class="container" id="mainController">
		<h1>‚öΩ Scoreboard Control</h1>
		<div class="user-bar">
			<span>Welcome, <strong id="displayName"></strong></span>
			<span class="logout" onclick="logout()">Logout</span>
		</div>
		<div id="connectionStatus" class="status-connecting">‚óè Connecting‚Ä¶</div>

		<div class="game-setup" id="gameSetup">
			<h3>Start New Game</h3>
			<input type="text" id="setupHomeName" placeholder="Home Team Name" value="" />
			<input type="text" id="setupAwayName" placeholder="Opponent Team Name" value="" />
			<input type="text" id="setupVenue" placeholder="Venue (optional)" value="" />
			<br>
			<button class="btn-success" id="createGameBtn" onclick="createGame()">‚öΩ Kick Off!</button>
		</div>

		<div id="activeGame" style="display: none;">
			<div class="scoreboard-wrapper">
				<div class="scoreboard">
					<!-- Home Team -->
					<div class="team">
						<div class="team-label">Home Team</div>
						<input id="homeNameInput" class="team-name-input" placeholder="Home" />
						<div class="score-display" id="homeScoreDisplay">0</div>
						<div class="score-controls">
							<button class="btn-success btn-sm" onclick="changeScore('home', 1)">+1</button>
							<button class="btn-success btn-sm" onclick="changeScore('home', -1)">-1</button>
						</div>
						<div style="margin-top: 8px;">
							<div class="control-row">
								<button class="btn-light-warning btn-sm" onclick="changeCard('home','yellow',1)">+1</button>
								<input id="homeYellowInput" class="mini" readonly />
								<button class="btn-light-warning btn-sm" onclick="changeCard('home','yellow',-1)">-1</button>
							</div>
							<div class="control-row">
								<button class="btn-danger btn-sm" onclick="changeCard('home','red',1)">+1</button>
								<input id="homeRedInput" class="mini" readonly />
								<button class="btn-danger btn-sm" onclick="changeCard('home','red',-1)">-1</button>
							</div>
						</div>
						<div class="appearance-inline">
							<div class="appearance-row">
								<label>Logo</label>
								<span id="homeLogoPreviewWrap"><span class="logo-placeholder">üè†</span></span>
								<label for="homeLogoFile" class="file-input-label">Browse</label>
								<input type="file" id="homeLogoFile" accept="image/*" onchange="previewLogo('home', this)" />
							</div>
							<div class="appearance-row">
								<label>Jersey</label>
								<input type="color" id="homeJerseyColor" class="color-picker" value="#8B0000" onchange="saveAppearance('home')" />
							</div>
							<div class="appearance-row">
								<label>Number</label>
								<input type="color" id="homeNumberColor" class="color-picker" value="#FFFFFF" onchange="saveAppearance('home')" />
							</div>
						</div>
					</div>

					<!-- Timer + Period -->
					<div class="timer-section">
						<div class="panel-title">‚è±Ô∏è Timer</div>
						<div class="timer-display" id="timerDisplay">00:00</div>
						<div class="timer-controls">
							<button class="btn-success btn-sm" onclick="handlePlay()">‚ñ∂</button>
							<button class="btn-secondary btn-sm" onclick="apiPost('timer/stop')">‚è∏</button>
							<button class="btn-danger btn-sm" onclick="apiPost('timer/reset')">‚Üª</button>
						</div>
						<div class="control-row">
							<input id="timerSetInput" class="mini" placeholder="00:00" style="width: 55px;" />
							<button class="btn-primary btn-sm" onclick="setTimer()">Set</button>
						</div>
						<div class="timer-mode" id="timerMode">Counting Up</div>
						<div class="control-row">
							<button class="btn-secondary btn-sm" onclick="setTimerMode(false)">‚Üë Up</button>
							<button class="btn-secondary btn-sm" onclick="setTimerMode(true)">‚Üì Down</button>
						</div>
						<div class="half-settings">
							<label>Half (min)</label>
							<input id="halfLengthInput" value="45" onchange="saveHalfSettings()" />
							<label>OT (min)</label>
							<input id="otLengthInput" value="5" onchange="saveHalfSettings()" />
						</div>
						<div style="text-align: center; margin-bottom: 6px;">
							<span class="period-badge period-1h" id="periodBadge">1ST HALF</span>
						</div>
						<div class="period-buttons" id="allPeriodButtons">
							<button class="btn-primary btn-sm active" data-period="1H" onclick="setPeriod('1H')">1st Half</button>
							<button class="btn-success btn-sm" data-period="2H" onclick="setPeriod('2H')">2nd Half</button>
							<button class="btn-warning btn-sm" data-period="OT1" onclick="setPeriod('OT1')">OT 1</button>
							<button class="btn-danger btn-sm" data-period="OT2" onclick="setPeriod('OT2')">OT 2</button>
							<button class="btn-sm" style="background:#9C27B0;" data-period="PEN" onclick="setPeriod('PEN')">Penalties</button>
						</div>
					</div>

					<!-- Away Team -->
					<div class="team">
						<div class="team-label">Away Team</div>
						<input id="awayNameInput" class="team-name-input" placeholder="Away" />
						<div class="score-display" id="awayScoreDisplay">0</div>
						<div class="score-controls">
							<button class="btn-success btn-sm" onclick="changeScore('away', 1)">+1</button>
							<button class="btn-success btn-sm" onclick="changeScore('away', -1)">-1</button>
						</div>
						<div style="margin-top: 8px;">
							<div class="control-row">
								<button class="btn-light-warning btn-sm" onclick="changeCard('away','yellow',1)">+1</button>
								<input id="awayYellowInput" class="mini" readonly />
								<button class="btn-light-warning btn-sm" onclick="changeCard('away','yellow',-1)">-1</button>
							</div>
							<div class="control-row">
								<button class="btn-danger btn-sm" onclick="changeCard('away','red',1)">+1</button>
								<input id="awayRedInput" class="mini" readonly />
								<button class="btn-danger btn-sm" onclick="changeCard('away','red',-1)">-1</button>
							</div>
						</div>
						<div class="appearance-inline">
							<div class="appearance-row">
								<label>Logo</label>
								<span id="awayLogoPreviewWrap"><span class="logo-placeholder">üë§</span></span>
								<label for="awayLogoFile" class="file-input-label">Browse</label>
								<input type="file" id="awayLogoFile" accept="image/*" onchange="previewLogo('away', this)" />
							</div>
							<div class="appearance-row">
								<label>Jersey</label>
								<input type="color" id="awayJerseyColor" class="color-picker" value="#FFFFFF" onchange="saveAppearance('away')" />
							</div>
							<div class="appearance-row">
								<label>Number</label>
								<input type="color" id="awayNumberColor" class="color-picker" value="#003366" onchange="saveAppearance('away')" />
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="reset-row">
				<button class="btn-danger btn-sm" onclick="resetAll()">üîÑ Reset All</button>
			</div>

			<!-- ===== PENALTY SECTION ‚Äî ALWAYS VISIBLE for testing ===== -->
			<div class="penalty-section" id="penaltySection">
				<div class="panel-title">‚öΩ Penalty Shootout</div>
				<div class="penalty-grid">
					<div class="penalty-team">
						<div class="penalty-team-name" id="penHomeTeamName">HOME</div>
						<div class="penalty-kicks" id="penHomeKicks"></div>
						<div class="penalty-controls">
							<button class="btn-success btn-sm" onclick="recordPenalty('home', true)">‚öΩ Goal</button>
							<button class="btn-danger btn-sm" onclick="recordPenalty('home', false)">‚úó Miss</button>
						</div>
					</div>
					<div style="text-align: center; padding-top: 20px;">
						<div style="display: flex; align-items: center; gap: 6px;">
							<span class="penalty-score" id="penHomeScore">0</span>
							<span class="penalty-score-sep">-</span>
							<span class="penalty-score" id="penAwayScore">0</span>
						</div>
						<div style="margin-top: 8px; font-size: 10px; color: #888;" id="penRoundLabel">Round 1</div>
					</div>
					<div class="penalty-team">
						<div class="penalty-team-name" id="penAwayTeamName">OPPONENT</div>
						<div class="penalty-kicks" id="penAwayKicks"></div>
						<div class="penalty-controls">
							<button class="btn-success btn-sm" onclick="recordPenalty('away', true)">‚öΩ Goal</button>
							<button class="btn-danger btn-sm" onclick="recordPenalty('away', false)">‚úó Miss</button>
						</div>
					</div>
				</div>
				<div class="penalty-winner" id="penaltyWinner"></div>
				<div style="text-align: center; margin-top: 8px;">
					<button class="btn-secondary btn-sm" onclick="undoLastPenalty()">‚Ü© Undo Last</button>
					<button class="btn-danger btn-sm" onclick="resetPenalties()">üîÑ Reset PKs</button>
				</div>
			</div>

			<div class="obs-urls" id="obsUrls">
				<div class="panel-title">üì∫ OBS Browser Source URLs</div>
				<div class="theme-selector">
					<label>Overlay Theme:</label>
					<select id="themeSelect" onchange="updateObsUrls()">
						<option value="DeepTide" selected>üåä DeepTide</option>
					</select>
				</div>
				<div id="obsUrlList"></div>
			</div>

			<div class="state-compact" id="stateBox">Waiting for data...</div>
		</div>
	</div>

	<script>
		const API_BASE = window.location.origin + '/api';
		let token = localStorage.getItem('sc_token');
		let streamKey = localStorage.getItem('sc_streamKey');
		let displayName = localStorage.getItem('sc_displayName');
		let lastState = null;
		let unsavedFields = new Set();
		let connection = null;
		let localTimerInterval = null;
		let pendingLogos = { home: null, away: null };

		let currentPeriod = '1H';
		let halfLengthMinutes = parseInt(localStorage.getItem('sc_halfLength')) || 45;
		let otLengthMinutes = parseInt(localStorage.getItem('sc_otLength')) || 5;
		let halftimeAutoStopped = false;

		let penaltyHomeKicks = [];
		let penaltyAwayKicks = [];

		// ===== Performance: cache heavy DOM updates =====
		let cachedHomeLogoUrl = null;
		let cachedAwayLogoUrl = null;
		let cachedPenaltyKey = '';

		function showToast(msg, type = 'error') {
			const toast = document.getElementById('toast');
			toast.textContent = msg;
			toast.className = `toast show ${type === 'warning' ? 'warning' : ''}`;
			setTimeout(() => { toast.className = 'toast'; }, 3000);
		}

		function setButtonLoading(btn, isLoading, loadingText) {
			if (isLoading) {
				btn.disabled = true;
				btn._originalHTML = btn.innerHTML;
				btn.innerHTML = '<span class="btn-spinner"></span>' + (loadingText || btn.textContent);
			} else {
				btn.disabled = false;
				if (btn._originalHTML) btn.innerHTML = btn._originalHTML;
			}
		}

		// ---- AUTH ----
		function showLogin() {
			document.getElementById('loginScreen').style.display = 'block';
			document.getElementById('mainController').style.display = 'none';
		}
		function showController() {
			document.getElementById('loginScreen').style.display = 'none';
			document.getElementById('mainController').style.display = 'block';
			document.getElementById('displayName').textContent = displayName || 'Streamer';
			document.getElementById('loadingOverlay').style.display = 'flex';
			initController();
		}

		async function login() {
			const email = document.getElementById('loginEmail').value;
			const password = document.getElementById('loginPassword').value;
			const btn = document.getElementById('loginBtn');
			setButtonLoading(btn, true, 'Signing In‚Ä¶');
			try {
				const res = await fetch(`${API_BASE}/auth/login`, {
					method: 'POST', headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ emailAddress: email, password })
				});
				const data = await res.json();
				if (data.success) {
					token = data.token; streamKey = data.streamKey; displayName = data.displayName;
					localStorage.setItem('sc_token', token);
					localStorage.setItem('sc_streamKey', streamKey);
					localStorage.setItem('sc_displayName', displayName);
					showController();
				} else { document.getElementById('loginError').textContent = data.message || 'Login failed'; }
			} catch (e) { document.getElementById('loginError').textContent = 'Connection error'; }
			finally { setButtonLoading(btn, false); }
		}

		function logout() {
			localStorage.removeItem('sc_token'); localStorage.removeItem('sc_streamKey'); localStorage.removeItem('sc_displayName');
			token = null; streamKey = null;
			if (connection) connection.stop();
			showLogin();
		}

		// ---- OBS URLs ----
		function updateObsUrls() {
			const base = window.location.origin;
			const theme = document.getElementById('themeSelect').value;
			const params = `key=${streamKey}&boardStyleName=${theme}`;
			document.getElementById('obsUrlList').innerHTML = `
				<div class="obs-url-row"><span>Pre-Game:</span> <code id="url-pregame">${base}/overlay/pregame.html?${params}</code> <button class="copy-btn btn-sm" onclick="copyUrl('url-pregame')">Copy</button></div>
				<div class="obs-url-row"><span>Scorecard:</span> <code id="url-scoreboard">${base}/overlay/scoreboard.html?${params}</code> <button class="copy-btn btn-sm" onclick="copyUrl('url-scoreboard')">Copy</button></div>
				<div class="obs-url-row"><span>Half Time:</span> <code id="url-halftime">${base}/overlay/halftime.html?${params}</code> <button class="copy-btn btn-sm" onclick="copyUrl('url-halftime')">Copy</button></div>
				<div class="obs-url-row"><span>Full Time:</span> <code id="url-fulltime">${base}/overlay/fulltime.html?${params}</code> <button class="copy-btn btn-sm" onclick="copyUrl('url-fulltime')">Copy</button></div>
				<div class="obs-url-row"><span>Penalties:</span> <code id="url-penalties">${base}/overlay/penalties.html?${params}</code> <button class="copy-btn btn-sm" onclick="copyUrl('url-penalties')">Copy</button></div>
			`;
		}

		function copyUrl(elementId) {
			const text = document.getElementById(elementId).textContent;
			navigator.clipboard.writeText(text).then(() => {
				const btn = document.getElementById(elementId).nextElementSibling;
				const orig = btn.textContent;
				btn.textContent = '‚úì'; btn.style.background = '#4CAF50';
				setTimeout(() => { btn.textContent = orig; btn.style.background = '#555'; }, 1500);
			});
		}

		// ---- INIT ----
		async function initController() {
			document.getElementById('halfLengthInput').value = halfLengthMinutes;
			document.getElementById('otLengthInput').value = otLengthMinutes;
			updateObsUrls();
			await loadGameState();
			document.getElementById('loadingOverlay').style.display = 'none';
			connectSignalR();
			initNameInputs();
			['homeNameInput', 'awayNameInput'].forEach(id => {
				document.getElementById(id)?.addEventListener('input', () => unsavedFields.add(id));
			});
		}

		async function loadGameState() {
			try {
				const res = await fetch(`${API_BASE}/game/state`, { headers: authHeaders() });
				if (res.ok) {
					const state = await res.json();
					lastState = state;
					if (state.currentPeriod) currentPeriod = state.currentPeriod;
					if (state.halfLengthMinutes) { halfLengthMinutes = state.halfLengthMinutes; document.getElementById('halfLengthInput').value = halfLengthMinutes; }
					if (state.otLengthMinutes) { otLengthMinutes = state.otLengthMinutes; document.getElementById('otLengthInput').value = otLengthMinutes; }
					if (state.homePenaltyKicks) { try { penaltyHomeKicks = JSON.parse(state.homePenaltyKicks); } catch(e) { penaltyHomeKicks = []; } }
					if (state.awayPenaltyKicks) { try { penaltyAwayKicks = JSON.parse(state.awayPenaltyKicks); } catch(e) { penaltyAwayKicks = []; } }
					showActiveGame(state);
					// Logos arrive via SignalR LogosUpdated event after JoinStream
				} else { showGameSetup(); }
			} catch { showGameSetup(); }
		}

		function showGameSetup() { document.getElementById('gameSetup').style.display = 'block'; document.getElementById('activeGame').style.display = 'none'; }
		function showActiveGame(state) { document.getElementById('gameSetup').style.display = 'none'; document.getElementById('activeGame').style.display = 'block'; applyState(state); }

		async function createGame() {
			const btn = document.getElementById('createGameBtn');
			setButtonLoading(btn, true, 'Creating‚Ä¶');
			try {
				const homeName = document.getElementById('setupHomeName').value || 'Home';
				const awayName = document.getElementById('setupAwayName').value || 'Opponent';
				const venue = document.getElementById('setupVenue').value;
				await fetch(`${API_BASE}/game/create`, {
					method: 'POST', headers: { ...authHeaders(), 'Content-Type': 'application/json' },
					body: JSON.stringify({ homeTeamName: homeName, awayTeamName: awayName, venue })
				});
				currentPeriod = '1H'; penaltyHomeKicks = []; penaltyAwayKicks = []; halftimeAutoStopped = false;
				await loadGameState();
				saveHalfSettings();
			} finally {
				setButtonLoading(btn, false);
			}
		}

		// ---- SignalR ----
		function connectSignalR() {
			setConnectionStatus(false);
			connection = new signalR.HubConnectionBuilder()
				.withUrl(`${window.location.origin}/hubs/game`, { accessTokenFactory: () => token })
				.withAutomaticReconnect()
				.build();
			connection.on("GameStateUpdated", (state) => {
				lastState = state;
				if (state.currentPeriod) currentPeriod = state.currentPeriod;
				if (state.homePenaltyKicks) { try { penaltyHomeKicks = JSON.parse(state.homePenaltyKicks); } catch(e) {} }
				if (state.awayPenaltyKicks) { try { penaltyAwayKicks = JSON.parse(state.awayPenaltyKicks); } catch(e) {} }
				applyState(state);
			});
			// Logos arrive on a separate channel ‚Äî only on join/reconnect and appearance changes
			connection.on("LogosUpdated", (homeLogoUrl, awayLogoUrl) => {
				cachedHomeLogoUrl = homeLogoUrl;
				cachedAwayLogoUrl = awayLogoUrl;
				setLogoPreview('home', homeLogoUrl);
				setLogoPreview('away', awayLogoUrl);
			});
			connection.onreconnecting(() => setConnectionStatus(false));
			connection.onreconnected(() => { setConnectionStatus(true); if (streamKey) connection.invoke("JoinStream", streamKey); });
			connection.start().then(() => { setConnectionStatus(true); if (streamKey) connection.invoke("JoinStream", streamKey); })
				.catch(() => setConnectionStatus(false));
		}

		function setConnectionStatus(connected) {
			const el = document.getElementById('connectionStatus');
			if (connected) {
				el.textContent = 'üü¢ Connected';
				el.style.color = '#4CAF50';
				el.classList.remove('status-connecting');
			} else {
				el.textContent = '‚óè Connecting‚Ä¶';
				el.style.color = '';
				el.classList.add('status-connecting');
			}
		}

		// ===== PLAY ‚Äî auto-advance to 2H at halftime =====
		async function handlePlay() {
			if (lastState) {
				const secs = computeTimer(lastState);
				if (lastState.timerDirection === 'DOWN' && secs <= 0) {
					showToast('‚ö†Ô∏è Timer is at 0:00 in countdown mode. Reset or set a new time before starting.', 'warning');
					return;
				}
				// At halftime: auto-advance to 2nd Half, then resume
				if (currentPeriod === '1H' && secs >= halfLengthMinutes * 60) {
					currentPeriod = '2H';
					halftimeAutoStopped = false;
					updatePeriodUI();
					await apiPost('period', { currentPeriod: '2H', halfLengthMinutes, otLengthMinutes });
				}
			}
			await apiPost('timer/start');
		}

		// ===== PERIOD MANAGEMENT =====
		function saveHalfSettings() {
			halfLengthMinutes = parseInt(document.getElementById('halfLengthInput').value) || 45;
			otLengthMinutes = parseInt(document.getElementById('otLengthInput').value) || 5;
			localStorage.setItem('sc_halfLength', halfLengthMinutes);
			localStorage.setItem('sc_otLength', otLengthMinutes);
			apiPost('period', { currentPeriod, halfLengthMinutes, otLengthMinutes });
		}

		async function setPeriod(period) {
			currentPeriod = period;
			halftimeAutoStopped = false;
			updatePeriodUI();
			await apiPost('period', { currentPeriod: period, halfLengthMinutes, otLengthMinutes });
			// PEN: auto-stop the clock (like hitting pause)
			if (period === 'PEN') {
				await apiPost('timer/stop');
			}
		}

		function getPeriodLabel(period) {
			const labels = { '1H': '1ST HALF', '2H': '2ND HALF', 'OT1': 'OVERTIME 1', 'OT2': 'OVERTIME 2', 'PEN': 'PENALTIES' };
			return labels[period] || '1ST HALF';
		}
		function getPeriodClass(period) {
			const classes = { '1H': 'period-1h', '2H': 'period-2h', 'OT1': 'period-ot1', 'OT2': 'period-ot2', 'PEN': 'period-pen' };
			return classes[period] || 'period-1h';
		}
		function getNextPeriod(current) {
			const order = ['1H', '2H', 'OT1', 'OT2', 'PEN'];
			const idx = order.indexOf(current);
			return idx < order.length - 1 ? order[idx + 1] : null;
		}

		function updatePeriodUI() {
			const badge = document.getElementById('periodBadge');
			badge.textContent = getPeriodLabel(currentPeriod);
			badge.className = `period-badge ${getPeriodClass(currentPeriod)}`;

			document.querySelectorAll('#allPeriodButtons button').forEach(btn => {
				btn.classList.toggle('active', btn.dataset.period === currentPeriod);
			});

			// NOTE: penalty section is ALWAYS visible now ‚Äî no show/hide toggle
		}

		// ---- Timer ----
		function computeTimer(state) {
			if (!state) return 0;
			let elapsed = state.elapsedSecondsAtPause || 0;
			if (state.isTimerRunning && state.timerStartedAtUtc) {
				const started = new Date(state.timerStartedAtUtc + 'Z').getTime();
				elapsed += Math.floor((Date.now() - started) / 1000);
			}
			if (state.timerDirection === 'DOWN') return Math.max(0, (state.timerSetSeconds || 0) - elapsed);
			return elapsed;
		}

		function startLocalTimer() {
			if (localTimerInterval) clearInterval(localTimerInterval);
			localTimerInterval = setInterval(() => {
				if (lastState?.isTimerRunning) {
					const secs = computeTimer(lastState);
					document.getElementById('timerDisplay').textContent = formatTime(secs);
					// Auto-stop at halftime only (1H ‚Üí halfLength minutes)
					if (currentPeriod === '1H' && !halftimeAutoStopped && secs >= halfLengthMinutes * 60) {
						halftimeAutoStopped = true;
						apiPost('timer/stop');
						showToast('‚è±Ô∏è Halftime!', 'warning');
					}
				}
			}, 200);
		}

		// ===== PENALTIES =====
		async function recordPenalty(team, isGoal) {
			const result = isGoal ? 'goal' : 'miss';
			if (team === 'home') penaltyHomeKicks.push(result);
			else penaltyAwayKicks.push(result);
			renderPenalties();
			await apiPost('penalty/record', { team, result });
		}

		function undoLastPenalty() {
			// Undo the most recent kick (away goes last in alternating order)
			if (penaltyAwayKicks.length > penaltyHomeKicks.length) {
				penaltyAwayKicks.pop();
				apiPost('penalty/undo', { team: 'away' });
			} else if (penaltyHomeKicks.length > 0) {
				penaltyHomeKicks.pop();
				apiPost('penalty/undo', { team: 'home' });
			}
			renderPenalties();
		}

		function resetPenalties() {
			if (!confirm('Reset all penalty kicks?')) return;
			penaltyHomeKicks = []; penaltyAwayKicks = [];
			renderPenalties();
			apiPost('penalty/reset');
		}

		function renderPenalties() {
			// Skip full DOM rebuild if nothing changed
			const penKey = JSON.stringify(penaltyHomeKicks) + '|' + JSON.stringify(penaltyAwayKicks);
			if (penKey === cachedPenaltyKey) return;
			cachedPenaltyKey = penKey;

			const homeGoals = penaltyHomeKicks.filter(k => k === 'goal').length;
			const awayGoals = penaltyAwayKicks.filter(k => k === 'goal').length;
			const maxRounds = Math.max(5, penaltyHomeKicks.length, penaltyAwayKicks.length);
			const totalKicks = penaltyHomeKicks.length + penaltyAwayKicks.length;
			const round = Math.floor(totalKicks / 2) + 1;

			document.getElementById('penHomeScore').textContent = homeGoals;
			document.getElementById('penAwayScore').textContent = awayGoals;
			document.getElementById('penRoundLabel').textContent = `Round ${Math.min(round, maxRounds)}`;
			document.getElementById('penHomeTeamName').textContent = lastState?.homeTeamName || 'HOME';
			document.getElementById('penAwayTeamName').textContent = lastState?.awayTeamName || 'OPPONENT';

			renderKickDots('penHomeKicks', penaltyHomeKicks, maxRounds);
			renderKickDots('penAwayKicks', penaltyAwayKicks, maxRounds);

			const winner = checkPenaltyWinner();
			const winnerEl = document.getElementById('penaltyWinner');
			if (winner) { winnerEl.textContent = `üèÜ ${winner} wins on penalties!`; winnerEl.style.display = 'block'; }
			else { winnerEl.style.display = 'none'; }
		}

		function renderKickDots(elementId, kicks, maxRounds) {
			const container = document.getElementById(elementId);
			let html = '';
			for (let i = 0; i < maxRounds; i++) {
				if (i < kicks.length) {
					html += kicks[i] === 'goal' ? `<div class="kick-dot kick-goal">‚úì</div>` : `<div class="kick-dot kick-miss">‚úó</div>`;
				} else {
					html += `<div class="kick-dot kick-pending">${i + 1}</div>`;
				}
			}
			container.innerHTML = html;
		}

		function checkPenaltyWinner() {
			const hk = penaltyHomeKicks, ak = penaltyAwayKicks;
			const hg = hk.filter(k => k === 'goal').length, ag = ak.filter(k => k === 'goal').length;
			const hl = hk.length, al = ak.length;
			if (hl <= 5 && al <= 5) {
				const homeRemaining = 5 - hl, awayRemaining = 5 - al;
				if (hl >= 1 && al >= 1 && ag > hg + homeRemaining) return lastState?.awayTeamName || 'AWAY';
				if (hl >= 1 && al >= 1 && hg > ag + awayRemaining) return lastState?.homeTeamName || 'HOME';
				if (hl >= 5 && al >= 5 && hg !== ag) return hg > ag ? (lastState?.homeTeamName || 'HOME') : (lastState?.awayTeamName || 'AWAY');
			}
			if (hl > 5 && al > 5 && hl === al && hg !== ag) return hg > ag ? (lastState?.homeTeamName || 'HOME') : (lastState?.awayTeamName || 'AWAY');
			return null;
		}

		// ---- Apply State ----
		function applyState(state) {
			if (!state) return;
			function setIfNotEditing(id, val) { const el = document.getElementById(id); if (el && document.activeElement !== el && !unsavedFields.has(id)) el.value = val; }
			setIfNotEditing('homeNameInput', state.homeTeamName);
			setIfNotEditing('awayNameInput', state.awayTeamName);
			document.getElementById('homeScoreDisplay').textContent = state.homeScore;
			document.getElementById('awayScoreDisplay').textContent = state.awayScore;
			document.getElementById('homeYellowInput').value = state.homeYellowCards;
			document.getElementById('homeRedInput').value = state.homeRedCards;
			document.getElementById('awayYellowInput').value = state.awayYellowCards;
			document.getElementById('awayRedInput').value = state.awayRedCards;
			const secs = computeTimer(state);
			document.getElementById('timerDisplay').textContent = formatTime(secs);
			document.getElementById('timerMode').textContent = state.timerDirection === 'DOWN' ? 'Counting Down' : 'Counting Up';
			if (state.isTimerRunning) { if (!localTimerInterval) startLocalTimer(); }
			else if (localTimerInterval) { clearInterval(localTimerInterval); localTimerInterval = null; }
			setColorIfNotActive('homeJerseyColor', state.homeJerseyColor || '#8B0000');
			setColorIfNotActive('homeNumberColor', state.homeNumberColor || '#FFFFFF');
			setColorIfNotActive('awayJerseyColor', state.awayJerseyColor || '#FFFFFF');
			setColorIfNotActive('awayNumberColor', state.awayNumberColor || '#003366');
			// Logos: handled separately via LogosUpdated SignalR event (not in game state broadcasts)
			updatePeriodUI();
			renderPenalties();
			document.getElementById('stateBox').innerHTML = `
				<strong>${state.homeTeamName}</strong> ${state.homeScore} - ${state.awayScore} <strong>${state.awayTeamName}</strong> |
				Timer: ${formatTime(secs)} (${state.timerDirection === 'DOWN' ? 'Down' : 'Up'}) ${state.isTimerRunning ? '‚ñ∂' : '‚è∏'} |
				Period: <strong>${getPeriodLabel(currentPeriod)}</strong>
			`;
		}

		function setColorIfNotActive(id, color) { const el = document.getElementById(id); if (el && document.activeElement !== el) el.value = color; }

		function setLogoPreview(team, dataUrl) {
			const wrap = document.getElementById(`${team}LogoPreviewWrap`);
			if (!dataUrl) wrap.innerHTML = `<span class="logo-placeholder">${team === 'home' ? 'üè†' : 'üë§'}</span>`;
			else wrap.innerHTML = `<img src="${dataUrl}" class="logo-preview" alt="${team} logo" />`;
		}

		function previewLogo(team, input) {
			const file = input.files[0]; if (!file) return;
			if (file.size > 2 * 1024 * 1024) { alert('Logo must be under 2MB'); return; }
			const reader = new FileReader();
			reader.onload = (e) => { pendingLogos[team] = e.target.result; setLogoPreview(team, e.target.result); saveAppearance(team); };
			reader.readAsDataURL(file);
		}

		async function saveAppearance(team) {
			const hasLogo = !!pendingLogos[team];
			if (hasLogo) showToast('Saving appearance‚Ä¶', 'warning');
			await apiPost(`team/${team}/appearance`, {
				jerseyColor: document.getElementById(`${team}JerseyColor`).value,
				numberColor: document.getElementById(`${team}NumberColor`).value,
				logoData: pendingLogos[team] || undefined
			});
			pendingLogos[team] = null;
		}

		function initNameInputs() {
			document.getElementById('homeNameInput').addEventListener('keydown', (e) => {
				if (e.key === 'Enter') { e.preventDefault(); apiPost('team/home/name', { name: e.target.value }); unsavedFields.delete('homeNameInput'); e.target.blur(); }
			});
			document.getElementById('awayNameInput').addEventListener('keydown', (e) => {
				if (e.key === 'Enter') { e.preventDefault(); apiPost('team/away/name', { name: e.target.value }); unsavedFields.delete('awayNameInput'); e.target.blur(); }
			});
		}

		function authHeaders() { return { 'Authorization': `Bearer ${token}` }; }
		async function apiPost(path, body) {
			await fetch(`${API_BASE}/game/${path}`, {
				method: 'POST', headers: { ...authHeaders(), 'Content-Type': 'application/json' },
				body: body ? JSON.stringify(body) : undefined
			});
		}

		async function changeScore(team, delta) {
			if (!lastState) return;
			const current = team === 'home' ? lastState.homeScore : lastState.awayScore;
			await apiPost(`score/${team}`, { score: Math.max(0, current + delta) });
		}
		async function changeCard(team, cardType, delta) {
			if (!lastState) return;
			let current;
			if (team === 'home') current = cardType === 'yellow' ? lastState.homeYellowCards : lastState.homeRedCards;
			else current = cardType === 'yellow' ? lastState.awayYellowCards : lastState.awayRedCards;
			await apiPost(`cards/${team}/${cardType}`, { count: Math.max(0, current + delta) });
		}
		async function setTimer() {
			const val = document.getElementById('timerSetInput').value.trim(); if (!val) return;
			const parts = val.split(':'); if (parts.length !== 2) return;
			const totalSec = parseInt(parts[0]) * 60 + parseInt(parts[1]); if (isNaN(totalSec)) return;
			await apiPost('timer/set', { seconds: totalSec });
		}
		async function setTimerMode(countDown) { await apiPost('timer/mode', { countDown }); }
		async function resetAll() { if (confirm('Reset entire game?')) await apiPost('reset'); }

		function formatTime(sec) {
			const m = String(Math.floor(sec / 60)).padStart(2, '0');
			const s = String(sec % 60).padStart(2, '0');
			return `${m}:${s}`;
		}

		if (token) showController(); else showLogin();
	</script>
</body>
</html>
