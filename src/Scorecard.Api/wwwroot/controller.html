<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoreboard Control</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: #1a1a1a; padding: 15px; color: #fff; }

        /* Login Screen */
        .login-screen {
            max-width: 380px; margin: 80px auto; background: #2a2a2a;
            border-radius: 10px; padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5); text-align: center;
        }
        .login-screen h2 { color: #4CAF50; margin-bottom: 20px; font-size: 18px; letter-spacing: 2px; text-transform: uppercase; }
        .login-screen input {
            width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #555;
            background: #333; color: #fff; border-radius: 4px; font-size: 14px;
        }
        .login-screen button {
            width: 100%; padding: 10px; font-size: 14px; cursor: pointer; border-radius: 4px;
            border: none; background: #4CAF50; color: white; font-weight: bold; margin-top: 5px;
        }
        .login-error { color: #f44336; font-size: 12px; margin-top: 8px; }

        /* Main Controller */
        .container {
            max-width: 480px; margin: 0 auto; background: #2a2a2a;
            border-radius: 10px; padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5); display: none;
        }
        h1 { text-align: center; font-size: 20px; margin-bottom: 15px; color: #4CAF50; text-transform: uppercase; letter-spacing: 2px; }
        
        .user-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; font-size: 11px; color: #888;
        }
        .user-bar .logout { cursor: pointer; color: #f44336; text-decoration: underline; }

        #connectionStatus {
            text-align: center; font-size: 11px; margin-bottom: 15px; padding: 4px; border-radius: 4px; background: #333;
        }

        /* Game Setup */
        .game-setup {
            background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 15px;
            border: 1px solid #444; text-align: center; display: none;
        }
        .game-setup h3 { color: #4CAF50; font-size: 14px; margin-bottom: 12px; }
        .game-setup input {
            width: 80%; padding: 8px; margin-bottom: 8px; border: 1px solid #555;
            background: #333; color: #fff; border-radius: 4px; font-size: 13px; text-align: center;
        }
        .game-setup button { margin-top: 8px; }

        /* Scoreboard Layout */
        .scoreboard-wrapper { transform: scale(0.95); transform-origin: top center; width: 100%; display: flex; justify-content: center; }
        .scoreboard {
            display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; margin-bottom: 15px;
            background: #1a1a1a; padding: 15px; border-radius: 8px; border: 2px solid #444; width: 285%;
        }
        .team { text-align: center; }
        .team-label { font-size: 10px; color: #888; margin-bottom: 5px; text-transform: uppercase; }
        .team-name-input {
            width: 100%; padding: 6px; font-size: 13px; border: 1px solid #555;
            background: #333; color: #fff; border-radius: 4px; margin-bottom: 8px;
            text-align: center; font-weight: bold;
        }
        .score-display {
            font-size: 28px; font-weight: bold; color: #FFD700; text-align: center;
            margin: 10px 0; font-family: 'Impact', sans-serif;
        }
        .score-controls { display: flex; justify-content: center; gap: 5px; margin-top: 8px; }

        /* Timer Section */
        .timer-section {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-left: 2px solid #444; border-right: 2px solid #444; padding: 0 20px;
        }
        .timer-display { font-size: 42px; font-weight: bold; color: #4CAF50; font-family: 'Courier New', monospace; margin-bottom: 8px; }
        .timer-controls { display: flex; gap: 5px; margin-bottom: 6px; }
        .timer-mode { font-size: 10px; color: #888; margin-top: 4px; }

        /* boards */
        .control-row { display: flex; align-items: center; gap: 5px; margin-bottom: 6px; justify-content: center; }

        /* Buttons */
        button {
            padding: 6px 12px; font-size: 11px; cursor: pointer; border-radius: 4px;
            border: none; background: #4CAF50; color: white; font-weight: bold; transition: all 0.2s;
        }
        button:hover { opacity: 0.8; transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        .btn-sm { padding: 4px 8px; font-size: 10px; }
        .btn-primary { background: #2196F3; }
        .btn-success { background: #4CAF50; }
        .btn-danger { background: #f44336; }
        .btn-warning { background: #ff9800; }
        .btn-secondary { background: #666; }
        .btn-light-warning { background: #FFB74D; }
        .btn-light-danger { background: #E57373; }

        input.mini { width: 35px; padding: 4px; font-size: 11px; text-align: center; border: 1px solid #555; background: #333; color: #fff; border-radius: 3px; }

        .update-names-btn { width: 100%; padding: 8px; font-size: 12px; margin-top: 10px; }
        .panel-title { font-size: 11px; color: #4CAF50; margin-bottom: 8px; text-transform: uppercase; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 4px; }

        /* Game Status Buttons */
        .status-buttons { display: flex; gap: 5px; justify-content: center; margin: 10px 0; flex-wrap: wrap; }
        .status-btn { padding: 6px 14px; font-size: 11px; border-radius: 4px; border: 1px solid #555; background: #333; color: #aaa; cursor: pointer; }
        .status-btn.active { background: #4CAF50; color: #fff; border-color: #4CAF50; }

        /* State Display */
        .state-compact {
            background: #1a1a1a; padding: 8px; border-radius: 6px;
            font-size: 10px; line-height: 1.6; border: 1px solid #444; color: #aaa;
        }
        .state-compact strong { color: #4CAF50; }

        /* OBS URLs Section */
        .obs-urls {
            background: #1a1a1a; padding: 10px; border-radius: 6px; margin-top: 10px;
            border: 1px solid #444; font-size: 10px;
        }
        .obs-urls .panel-title { margin-bottom: 6px; }
        .obs-url-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .obs-url-row span { color: #aaa; }
        .obs-url-row code { color: #4CAF50; font-size: 9px; word-break: break-all; }
        .copy-btn { padding: 2px 6px; font-size: 9px; background: #555; }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div class="login-screen" id="loginScreen">
        <h2>‚öΩ Scoreboard Login</h2>
        <input type="email" id="loginEmail" placeholder="Email Address" />
        <input type="password" id="loginPassword" placeholder="Password" />
        <button onclick="login()">Sign In</button>
        <div class="login-error" id="loginError"></div>
        <div style="margin-top: 15px; font-size: 11px; color: #666;">
            <a href="/signup.html" style="color: #4CAF50;">Create Account</a>
        </div>
    </div>

    <!-- MAIN CONTROLLER -->
    <div class="container" id="mainController">
        <h1>‚öΩ Scoreboard Control</h1>
        <div class="user-bar">
            <span>Welcome, <strong id="displayName"></strong></span>
            <span class="logout" onclick="logout()">Logout</span>
        </div>
        <div id="connectionStatus">Connecting‚Ä¶</div>

        <!-- Game Setup (shown when no active game) -->
        <div class="game-setup" id="gameSetup">
            <h3>Start New Game</h3>
            <input type="text" id="setupHomeName" placeholder="Home Team Name" value="" />
            <input type="text" id="setupAwayName" placeholder="Opponent Team Name" value="" />
            <input type="text" id="setupVenue" placeholder="Venue (optional)" value="" />
            <br>
            <button class="btn-success" onclick="createGame()">‚öΩ Kick Off!</button>
        </div>

        <!-- Active Game Controls -->
        <div id="activeGame" style="display: none;">
            <!-- Status Buttons -->
            <div class="status-buttons">
                <button class="status-btn" data-status="PREGAME" onclick="setStatus('PREGAME')">Pre-Game</button>
                <button class="status-btn active" data-status="LIVE" onclick="setStatus('LIVE')">Live</button>
                <button class="status-btn" data-status="HALFTIME" onclick="setStatus('HALFTIME')">Half Time</button>
                <button class="status-btn" data-status="FULLTIME" onclick="setStatus('FULLTIME')">Full Time</button>
            </div>

            <div class="scoreboard-wrapper">
                <div class="scoreboard">
                    <!-- Home Team -->
                    <div class="team">
                        <div class="team-label">Home Team</div>
                        <input id="homeNameInput" class="team-name-input" placeholder="Home" />
                        <div class="score-display" id="homeScoreDisplay">0</div>
                        <div class="score-controls">
                            <button class="btn-success btn-sm" onclick="changeScore('home', 1)">+1</button>
                            <button class="btn-success btn-sm" onclick="changeScore('home', -1)">-1</button>
                        </div>
                        <div style="margin-top: 8px;">
                            <div class="control-row">
                                <button class="btn-light-warning btn-sm" onclick="changeboard('home','yellow',1)">+1</button>
                                <input id="homeYellowInput" class="mini" readonly />
                                <button class="btn-light-warning btn-sm" onclick="changeboard('home','yellow',-1)">-1</button>
                            </div>
                            <div class="control-row">
                                <button class="btn-danger btn-sm" onclick="changeboard('home','red',1)">+1</button>
                                <input id="homeRedInput" class="mini" readonly />
                                <button class="btn-danger btn-sm" onclick="changeboard('home','red',-1)">-1</button>
                            </div>
                        </div>
                    </div>

                    <!-- Timer -->
                    <div class="timer-section">
                        <div class="panel-title">‚è±Ô∏è Timer</div>
                        <div class="timer-display" id="timerDisplay">00:00</div>
                        <div class="control-row">
                            <input id="timerSetInput" class="mini" placeholder="00:00" style="width: 55px;" />
                            <button class="btn-primary btn-sm" onclick="setTimer()">Set</button>
                        </div>
                        <div class="timer-controls">
                            <button class="btn-success btn-sm" onclick="apiPost('timer/start')">‚ñ∂</button>
                            <button class="btn-secondary btn-sm" onclick="apiPost('timer/stop')">‚è∏</button>
                            <button class="btn-danger btn-sm" onclick="apiPost('timer/reset')">‚Üª</button>
                        </div>
                        <div class="timer-mode" id="timerMode">Counting Up</div>
                        <div class="control-row">
                            <button class="btn-secondary btn-sm" onclick="setTimerMode(false)">‚Üë Up</button>
                            <button class="btn-secondary btn-sm" onclick="setTimerMode(true)">‚Üì Down</button>
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="btn-danger btn-sm" style="width: 100%;" onclick="resetAll()">üîÑ Reset All</button>
                        </div>
                    </div>

                    <!-- Away Team -->
                    <div class="team">
                        <div class="team-label">Away Team</div>
                        <input id="awayNameInput" class="team-name-input" placeholder="Away" />
                        <div class="score-display" id="awayScoreDisplay">0</div>
                        <div class="score-controls">
                            <button class="btn-success btn-sm" onclick="changeScore('away', 1)">+1</button>
                            <button class="btn-success btn-sm" onclick="changeScore('away', -1)">-1</button>
                        </div>
                        <div style="margin-top: 8px;">
                            <div class="control-row">
                                <button class="btn-light-warning btn-sm" onclick="changeboard('away','yellow',1)">+1</button>
                                <input id="awayYellowInput" class="mini" readonly />
                                <button class="btn-light-warning btn-sm" onclick="changeboard('away','yellow',-1)">-1</button>
                            </div>
                            <div class="control-row">
                                <button class="btn-danger btn-sm" onclick="changeboard('away','red',1)">+1</button>
                                <input id="awayRedInput" class="mini" readonly />
                                <button class="btn-danger btn-sm" onclick="changeboard('away','red',-1)">-1</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <button class="btn-primary update-names-btn" onclick="updateTeamNames()">Update Team Names</button>

            <!-- OBS URLs -->
            <div class="obs-urls" id="obsUrls">
                <div class="panel-title">üì∫ OBS Browser Source URLs</div>
                <div id="obsUrlList"></div>
            </div>

            <!-- State Display -->
            <div class="state-compact" id="stateBox">Waiting for data...</div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin + '/api';
        let token = localStorage.getItem('sc_token');
        let streamKey = localStorage.getItem('sc_streamKey');
        let displayName = localStorage.getItem('sc_displayName');
        let lastState = null;
        let unsavedFields = new Set();
        let connection = null;
        let localTimerInterval = null;

        // ---- AUTH ----
        function showLogin() {
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainController').style.display = 'none';
        }
        function showController() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainController').style.display = 'block';
            document.getElementById('displayName').textContent = displayName || 'Streamer';
            initController();
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            try {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ emailAddress: email, password })
                });
                const data = await res.json();
                if (data.success) {
                    token = data.token; streamKey = data.streamKey; displayName = data.displayName;
                    localStorage.setItem('sc_token', token);
                    localStorage.setItem('sc_streamKey', streamKey);
                    localStorage.setItem('sc_displayName', displayName);
                    showController();
                } else {
                    document.getElementById('loginError').textContent = data.message || 'Login failed';
                }
            } catch (e) { document.getElementById('loginError').textContent = 'Connection error'; }
        }

        function logout() {
            localStorage.removeItem('sc_token');
            localStorage.removeItem('sc_streamKey');
            localStorage.removeItem('sc_displayName');
            token = null; streamKey = null;
            if (connection) connection.stop();
            showLogin();
        }

        // ---- CONTROLLER ----
        async function initController() {
            // Show OBS URLs
            const base = window.location.origin;
            document.getElementById('obsUrlList').innerHTML = `
                <div class="obs-url-row"><span>Pre-Game:</span> <code>${base}/overlay/pregame.html?key=${streamKey}</code></div>
                <div class="obs-url-row"><span>Scoreboard:</span> <code>${base}/overlay/scoreboard.html?key=${streamKey}</code></div>
                <div class="obs-url-row"><span>Half Time:</span> <code>${base}/overlay/halftime.html?key=${streamKey}</code></div>
                <div class="obs-url-row"><span>Full Time:</span> <code>${base}/overlay/fulltime.html?key=${streamKey}</code></div>
            `;

            // Check for active game
            await loadGameState();

            // Connect SignalR
            connectSignalR();

            // Track unsaved fields
            ['homeNameInput', 'awayNameInput'].forEach(id => {
                document.getElementById(id)?.addEventListener('input', () => unsavedFields.add(id));
            });
        }

        async function loadGameState() {
            try {
                const res = await fetch(`${API_BASE}/game/state`, { headers: authHeaders() });
                if (res.ok) {
                    const state = await res.json();
                    lastState = state;
                    showActiveGame(state);
                } else {
                    showGameSetup();
                }
            } catch { showGameSetup(); }
        }

        function showGameSetup() {
            document.getElementById('gameSetup').style.display = 'block';
            document.getElementById('activeGame').style.display = 'none';
        }

        function showActiveGame(state) {
            document.getElementById('gameSetup').style.display = 'none';
            document.getElementById('activeGame').style.display = 'block';
            applyState(state);
        }

        async function createGame() {
            const homeName = document.getElementById('setupHomeName').value || 'Home';
            const awayName = document.getElementById('setupAwayName').value || 'Opponent';
            const venue = document.getElementById('setupVenue').value;
            await fetch(`${API_BASE}/game/create`, {
                method: 'POST', headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                body: JSON.stringify({ homeTeamName: homeName, awayTeamName: awayName, venue })
            });
            await loadGameState();
        }

        // ---- SignalR ----
        function connectSignalR() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl(`${window.location.origin}/hubs/game`, { accessTokenFactory: () => token })
                .withAutomaticReconnect()
                .build();

            connection.on("GameStateUpdated", (state) => {
                lastState = state;
                applyState(state);
            });

            connection.onreconnecting(() => setConnectionStatus(false));
            connection.onreconnected(() => {
                setConnectionStatus(true);
                if (streamKey) connection.invoke("JoinStream", streamKey);
            });

            connection.start().then(() => {
                setConnectionStatus(true);
                if (streamKey) connection.invoke("JoinStream", streamKey);
            }).catch(() => setConnectionStatus(false));
        }

        function setConnectionStatus(connected) {
            const el = document.getElementById('connectionStatus');
            el.textContent = connected ? 'üü¢ Connected' : 'üî¥ Disconnected';
            el.style.color = connected ? '#4CAF50' : '#f44336';
        }

        // ---- Client-side Timer ----
        function computeTimer(state) {
            if (!state) return 0;
            let elapsed = state.elapsedSecondsAtPause || 0;
            if (state.isTimerRunning && state.timerStartedAtUtc) {
                const started = new Date(state.timerStartedAtUtc + 'Z').getTime();
                elapsed += Math.floor((Date.now() - started) / 1000);
            }
            if (state.timerDirection === 'DOWN') return Math.max(0, (state.timerSetSeconds || 0) - elapsed);
            return elapsed;
        }

        function startLocalTimer() {
            if (localTimerInterval) clearInterval(localTimerInterval);
            localTimerInterval = setInterval(() => {
                if (lastState?.isTimerRunning) {
                    document.getElementById('timerDisplay').textContent = formatTime(computeTimer(lastState));
                }
            }, 200);
        }

        // ---- Apply State to UI ----
        function applyState(state) {
            if (!state) return;

            function setIfNotEditing(id, val) {
                const el = document.getElementById(id);
                if (el && document.activeElement !== el && !unsavedFields.has(id)) el.value = val;
            }

            setIfNotEditing('homeNameInput', state.homeTeamName);
            setIfNotEditing('awayNameInput', state.awayTeamName);

            document.getElementById('homeScoreDisplay').textContent = state.homeScore;
            document.getElementById('awayScoreDisplay').textContent = state.awayScore;
            document.getElementById('homeYellowInput').value = state.homeYellowboards;
            document.getElementById('homeRedInput').value = state.homeRedboards;
            document.getElementById('awayYellowInput').value = state.awayYellowboards;
            document.getElementById('awayRedInput').value = state.awayRedboards;

            const secs = computeTimer(state);
            document.getElementById('timerDisplay').textContent = formatTime(secs);
            document.getElementById('timerMode').textContent = state.timerDirection === 'DOWN' ? 'Counting Down' : 'Counting Up';

            if (state.isTimerRunning) startLocalTimer();
            else if (localTimerInterval) { clearInterval(localTimerInterval); localTimerInterval = null; }

            // Status buttons
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.status === state.gameStatus);
            });

            // State box
            document.getElementById('stateBox').innerHTML = `
                <strong>${state.homeTeamName}</strong> ${state.homeScore} - ${state.awayScore} <strong>${state.awayTeamName}</strong> |
                Timer: ${formatTime(secs)} (${state.timerDirection === 'DOWN' ? 'Down' : 'Up'}) ${state.isTimerRunning ? '‚ñ∂' : '‚è∏'} |
                Status: ${state.gameStatus}
            `;
        }

        // ---- API Helpers ----
        function authHeaders() { return { 'Authorization': `Bearer ${token}` }; }

        async function apiPost(path, body) {
            await fetch(`${API_BASE}/game/${path}`, {
                method: 'POST',
                headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                body: body ? JSON.stringify(body) : undefined
            });
        }

        async function changeScore(team, delta) {
            if (!lastState) return;
            const current = team === 'home' ? lastState.homeScore : lastState.awayScore;
            await apiPost(`score/${team}`, { score: Math.max(0, current + delta) });
        }

        async function changeboard(team, boardType, delta) {
            if (!lastState) return;
            let current;
            if (team === 'home') current = boardType === 'yellow' ? lastState.homeYellowboards : lastState.homeRedboards;
            else current = boardType === 'yellow' ? lastState.awayYellowboards : lastState.awayRedboards;
            await apiPost(`boards/${team}/${boardType}`, { count: Math.max(0, current + delta) });
        }

        async function updateTeamNames() {
            const home = document.getElementById('homeNameInput').value;
            const away = document.getElementById('awayNameInput').value;
            if (home) await apiPost('team/home/name', { name: home });
            if (away) await apiPost('team/away/name', { name: away });
            unsavedFields.clear();
        }

        async function setTimer() {
            const val = document.getElementById('timerSetInput').value.trim();
            if (!val) return;
            const parts = val.split(':');
            if (parts.length !== 2) return;
            const totalSec = parseInt(parts[0]) * 60 + parseInt(parts[1]);
            if (isNaN(totalSec)) return;
            await apiPost('timer/set', { seconds: totalSec });
        }

        async function setTimerMode(countDown) { await apiPost('timer/mode', { countDown }); }
        async function setStatus(status) { await apiPost('status', { status }); }
        async function resetAll() { if (confirm('Reset entire game?')) await apiPost('reset'); }

        function formatTime(sec) {
            const m = String(Math.floor(sec / 60)).padStart(2, '0');
            const s = String(sec % 60).padStart(2, '0');
            return `${m}:${s}`;
        }

        // ---- Init ----
        if (token) showController(); else showLogin();
    </script>
</body>
</html>
